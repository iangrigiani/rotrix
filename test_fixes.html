<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêõ Test de Correcciones - Rotrix</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
        }
        
        .test-container {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .game-section {
            flex: 1;
        }
        
        .test-section {
            flex: 1;
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
        }
        
        .test-results {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .pass { color: #4ade80; }
        .fail { color: #ef4444; }
        .warning { color: #fbbf24; }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        .auto-test {
            background: #10b981;
        }
        
        .auto-test:hover {
            background: #059669;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .score, .level {
            font-size: 18px;
            font-weight: bold;
        }
        
        .next-piece {
            width: 120px;
            height: 120px;
            border: 2px solid #444;
            background: #000;
        }
        
        canvas {
            border: 2px solid #444;
            background: #000;
        }
        
        .controls {
            color: white;
            text-align: center;
            margin-top: 20px;
        }
        
        .controls p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="game-section">
            <div class="game-info">
                <div class="score">Score: <span id="scoreDisplay">0</span></div>
                <div class="level">Level: <span id="levelDisplay">1</span></div>
                <canvas id="nextPieceCanvas" class="next-piece"></canvas>
            </div>
            <canvas id="gameCanvas"></canvas>
            <div class="controls">
                <p><strong>üéÆ Controles:</strong></p>
                <p>‚Üê ‚Üí : Mover pieza</p>
                <p>‚Üë : Rotar pieza</p>
                <p>‚Üì : Ca√≠da r√°pida</p>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üîß Test de Correcciones</h2>
            
            <div>
                <button onclick="runBasicTests()">üß™ Tests B√°sicos</button>
                <button onclick="runSpawnTests()">Test Spawn System</button>
                <button onclick="runGravityTests()">Test Gravity System</button>
                <button onclick="runAutoTest()">Test Autom√°tico (30s)</button>
                <button onclick="testLineDetection()">üîç Test Bug L√≠neas</button>
                <button onclick="testRealFullLine()">‚úÖ Test L√≠nea Completa</button>
                <button onclick="testInvertedGravityBug()">üîÑ Test Gravedad Invertida</button>
                <button onclick="testRecursiveLineDetection()">Test L√≠neas Recursivas</button>
                <button onclick="testInvertedRecursiveLines()">Test L√≠neas Recursivas Invertidas</button>
                <button onclick="testGravityDoesNotCreateLines()">üîç Test Gravedad Correcta</button>
                <button onclick="clearResults()">Limpiar Resultados</button>
            </div>
            
            <div class="test-results" id="testResults">
                <div class="pass">‚úÖ Sistema de testing inicializado</div>
                <div class="warning">‚ö†Ô∏è Esperando tests...</div>
            </div>
            
            <h3>üìä Estad√≠sticas en Tiempo Real</h3>
            <div id="liveStats" class="test-results">
                <div>Piezas spawneadas: <span id="spawnCount">0</span></div>
                <div>Piezas aterrizadas: <span id="landedCount">0</span></div>
                <div>Cambios de gravedad: <span id="gravityCount">0</span></div>
                <div>Spawns prevenidos: <span id="preventedCount">0</span></div>
            </div>
            
            <h3>üö® Detecci√≥n de Bugs</h3>
            <div id="bugDetection" class="test-results">
                <div class="pass">üîç Monitoreando...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { RotrixGame } from './rotrix.js';
        
        // Variables globales para testing
        let game;
        let testResults = [];
        let stats = {
            spawns: 0,
            landed: 0,
            gravityChanges: 0,
            prevented: 0,
            doubleSpawns: 0,
            cascadeGravity: 0
        };
        
        // Inicializar el juego
        window.onload = () => {
            game = new RotrixGame();
            window.testGame = game;
            
            // Interceptar logs para testing
            const originalLog = game.logger.log.bind(game.logger);
            game.logger.log = function(eventType, data) {
                originalLog(eventType, data);
                analyzeEvent(eventType, data);
                updateLiveStats();
            };
            
            addTestResult('‚úÖ Juego inicializado con sistema de testing', 'pass');
        };
        
        // Analizar eventos para detectar bugs
        function analyzeEvent(eventType, data) {
            switch(eventType) {
                case 'PIECE_SPAWN':
                    stats.spawns++;
                    checkDoubleSpawn(data);
                    break;
                    
                case 'PIECE_LANDED':
                    stats.landed++;
                    break;
                    
                case 'GRAVITY_SWITCH':
                    stats.gravityChanges++;
                    checkGravityCascade(data);
                    break;
                    
                case 'SPAWN_PREVENTED':
                    stats.prevented++;
                    addTestResult(`‚úÖ Spawn doble prevenido correctamente: ${data.reason}`, 'pass');
                    break;
                    
                case 'GRAVITY_SWITCH_PREVENTED':
                    addTestResult(`‚úÖ Cambio de gravedad en cascada prevenido: ${data.reason}`, 'pass');
                    break;
            }
        }
        
        let lastSpawnTime = 0;
        function checkDoubleSpawn(data) {
            const now = performance.now();
            if (now - lastSpawnTime < 100) { // Menos de 100ms entre spawns
                stats.doubleSpawns++;
                addTestResult(`üö® POSIBLE SPAWN DOBLE DETECTADO: Pieza #${data.pieceNumber}`, 'fail');
            }
            lastSpawnTime = now;
        }
        
        let lastGravityTime = 0;
        function checkGravityCascade(data) {
            const now = performance.now();
            if (data.piecesPlaced === 0 && now - lastGravityTime < 1000) {
                stats.cascadeGravity++;
                addTestResult(`üö® CAMBIO DE GRAVEDAD EN CASCADA: piecesPlaced=${data.piecesPlaced}`, 'fail');
            }
            lastGravityTime = now;
        }
        
        // Funciones de testing
        window.runBasicTests = function() {
            addTestResult('üß™ Ejecutando tests b√°sicos...', 'warning');
            
            // Test 1: Verificar que el juego est√° corriendo
            if (game && !game.gameOver) {
                addTestResult('‚úÖ Test 1: Juego activo', 'pass');
            } else {
                addTestResult('‚ùå Test 1: Juego no est√° activo', 'fail');
            }
            
            // Test 2: Verificar inicializaci√≥n correcta
            if (game.piecesPlaced === 0 && game.nextGravitySwitch > 0) {
                addTestResult('‚úÖ Test 2: Contador de piezas inicializado correctamente', 'pass');
            } else {
                addTestResult('‚ùå Test 2: Contador de piezas mal inicializado', 'fail');
            }
            
            // Test 3: Verificar bandera de protecci√≥n
            if (game.switchingGravity === false) {
                addTestResult('‚úÖ Test 3: Bandera de protecci√≥n inicializada', 'pass');
            } else {
                addTestResult('‚ùå Test 3: Bandera de protecci√≥n mal inicializada', 'fail');
            }
            
            // Test 4: Verificar logger
            if (game.logger && typeof game.logger.log === 'function') {
                addTestResult('‚úÖ Test 4: Sistema de logging funcional', 'pass');
            } else {
                addTestResult('‚ùå Test 4: Sistema de logging defectuoso', 'fail');
            }
        };
        
        window.runSpawnTests = function() {
            addTestResult('üë• Testing sistema de spawn...', 'warning');
            
            // Intentar spawn m√∫ltiple (deber√≠a fallar)
            const result1 = game.spawnPiece();
            const result2 = game.spawnPiece();
            
            if (result1 && !result2) {
                addTestResult('‚úÖ Spawn doble correctamente prevenido', 'pass');
            } else {
                addTestResult('‚ùå Sistema de prevenci√≥n de spawn doble fall√≥', 'fail');
            }
        };
        
        window.runGravityTests = function() {
            addTestResult('üîÑ Testing sistema de gravedad...', 'warning');
            
            // Verificar estado antes del test
            const initialSwitching = game.switchingGravity;
            if (!initialSwitching) {
                addTestResult('‚úÖ Estado inicial de gravedad correcto', 'pass');
                
                // Simular condici√≥n de cambio de gravedad
                const oldPieces = game.piecesPlaced;
                game.piecesPlaced = game.nextGravitySwitch;
                
                addTestResult(`‚ÑπÔ∏è Simulando cambio de gravedad (${oldPieces} ‚Üí ${game.piecesPlaced})`, 'warning');
            } else {
                addTestResult('‚ùå Sistema de gravedad en estado inconsistente', 'fail');
            }
        };
        
        window.runAutoTest = function() {
            addTestResult('ü§ñ Iniciando test autom√°tico...', 'warning');
            
            // Simular juego autom√°tico durante 30 segundos
            let testDuration = 30000;
            let interval = setInterval(() => {
                // Simular ca√≠da r√°pida
                game.movePiece(0, game.gravity);
                
                testDuration -= 100;
                if (testDuration <= 0) {
                    clearInterval(interval);
                    finishAutoTest();
                }
            }, 100);
        };
        
        function finishAutoTest() {
            addTestResult('ü§ñ Test autom√°tico completado', 'pass');
            addTestResult(`üìä Estad√≠sticas finales:`, 'warning');
            addTestResult(`   - Spawns: ${stats.spawns}`, 'warning');
            addTestResult(`   - Aterrizajes: ${stats.landed}`, 'warning');
            addTestResult(`   - Cambios de gravedad: ${stats.gravityChanges}`, 'warning');
            addTestResult(`   - Spawns prevenidos: ${stats.prevented}`, 'warning');
            
            // Calcular ratio de √©xito
            const spawnRatio = stats.landed / stats.spawns;
            if (spawnRatio > 0.8) {
                addTestResult(`‚úÖ Ratio spawn/aterrizaje: ${(spawnRatio * 100).toFixed(1)}% (BUENO)`, 'pass');
            } else {
                addTestResult(`‚ùå Ratio spawn/aterrizaje: ${(spawnRatio * 100).toFixed(1)}% (MALO)`, 'fail');
            }
            
            if (stats.doubleSpawns === 0) {
                addTestResult('‚úÖ Sin spawns dobles detectados', 'pass');
            } else {
                addTestResult(`‚ùå ${stats.doubleSpawns} spawns dobles detectados`, 'fail');
            }
            
            if (stats.cascadeGravity === 0) {
                addTestResult('‚úÖ Sin cambios de gravedad en cascada', 'pass');
            } else {
                addTestResult(`‚ùå ${stats.cascadeGravity} cambios de gravedad en cascada`, 'fail');
            }
        }
        
        function addTestResult(message, type = 'info') {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        function updateLiveStats() {
            document.getElementById('spawnCount').textContent = stats.spawns;
            document.getElementById('landedCount').textContent = stats.landed;
            document.getElementById('gravityCount').textContent = stats.gravityChanges;
            document.getElementById('preventedCount').textContent = stats.prevented;
            
            // Actualizar detecci√≥n de bugs
            const bugDiv = document.getElementById('bugDetection');
            bugDiv.innerHTML = '';
            
            if (stats.doubleSpawns > 0) {
                const div = document.createElement('div');
                div.className = 'fail';
                div.textContent = `üö® ${stats.doubleSpawns} spawns dobles detectados`;
                bugDiv.appendChild(div);
            }
            
            if (stats.cascadeGravity > 0) {
                const div = document.createElement('div');
                div.className = 'fail';
                div.textContent = `üö® ${stats.cascadeGravity} cambios de gravedad en cascada`;
                bugDiv.appendChild(div);
            }
            
            if (stats.doubleSpawns === 0 && stats.cascadeGravity === 0) {
                const div = document.createElement('div');
                div.className = 'pass';
                div.textContent = '‚úÖ Sin bugs detectados';
                bugDiv.appendChild(div);
            }
        }
    </script>
</body>
</html> 